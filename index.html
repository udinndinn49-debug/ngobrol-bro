<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Obrolin ajaa â€” Didukung oleh Supabase</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // FUNGSI UNTUK MENGATUR TEMA (TIDAK BERUBAH)
    (function() {
      const savedTheme = localStorage.getItem('obrolin_theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();
  </script>

  <style>
    :root {
      --bg: #ffffff; --card: #f9fafb; --text: #0f1724; --muted: #6b7280; --border: #e5e7eb;
      --hover-bg: rgba(243, 244, 246, 0.9); --reply-bg: #f3f4f6; --reply-border: #d1d5db;
      --accent: #2563eb; --success: #10b981; --radius: 12px; --shadow: 0 4px 12px rgba(16, 24, 40, 0.08);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    html.dark-mode {
      --bg: #121212; --card: #1f2937; --text: #f3f4f6; --muted: #9ca3af; --border: #374151;
      --hover-bg: rgba(243, 244, 246, 0.08); --reply-bg: #374151; --reply-border: #4b5563;
      --accent: #60a5fa; --shadow: 0 6px 20px rgba(0, 0, 0, 0.7);
    }
    * { box-sizing: border-box }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
    html.dark-mode ::-webkit-scrollbar { width: 8px; }
    html.dark-mode ::-webkit-scrollbar-track { background: var(--bg); }
    html.dark-mode ::-webkit-scrollbar-thumb { background-color: var(--reply-border); border-radius: 20px; border: 2px solid var(--bg); }
    .app { max-width: 980px; margin: 28px auto; padding: 18px }
    header { display: flex; gap: 12px; align-items: center; justify-content: space-between }
    .brand { display: flex; gap: 12px; align-items: center }
    .logo { width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #06b6d4); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; }
    h1 { font-size: 18px; margin: 0 }
    p.lead { margin: 0; color: var(--muted); font-size: 13px }
    .controls { display: flex; gap: 8px; align-items: center }
    button, .btn { background: var(--accent); color: white; border: none; padding: 10px 12px; border-radius: 10px; cursor: pointer; box-shadow: var(--shadow); transition: background 0.2s, box-shadow 0.2s; }
    button:hover, .btn:hover { opacity: 0.9; }
    .btn.secondary { background: transparent; color: var(--accent); border: 1px solid var(--border); box-shadow: none; transition: background 0.2s, color 0.2s, border-color 0.2s; }
    .btn.secondary:hover { background: rgba(37, 99, 235, 0.05); }
    html.dark-mode .btn.secondary:hover { background: rgba(255, 255, 255, 0.08); }
    .icon-btn { background: transparent; border: none; padding: 8px; border-radius: 8px; cursor: pointer; color: var(--text); }
    .icon-btn:hover { background: var(--hover-bg); }
    .grid { display: grid; grid-template-columns: 260px 1fr; gap: 18px; margin-top: 18px }
    .card { background: var(--card); border-radius: var(--radius); padding: 14px; box-shadow: var(--shadow); transition: background 0.3s, box-shadow 0.3s; }
    .categories { display: flex; flex-direction: column; gap: 8px }
    .cat { padding: 8px 10px; border-radius: 10px; cursor: pointer; color: var(--muted); display: flex; justify-content: space-between; transition: background 0.2s, color 0.2s; }
    .cat:hover { background: var(--hover-bg); color: var(--text); }
    .cat.active { background: rgba(37, 99, 235, 0.08); color: var(--accent); font-weight: 600; }
    html.dark-mode .cat.active { background: rgba(96, 165, 250, 0.2); }
    .thread { display: flex; gap: 12px; padding: 10px; border-radius: 10px; align-items: flex-start }
    .thread:hover { background: var(--hover-bg); }
    .meta { font-size: 12px; color: var(--muted) }
    textarea, input[type="text"], input[type="password"], select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); resize: vertical; background: var(--card); color: var(--text); transition: border-color 0.3s, background 0.3s; }
    .thread-title { font-size: 18px; margin: 0 }
    .reply { margin-top: 12px; padding: 10px; border-radius: 10px; border: 1px solid var(--reply-border); background: var(--reply-bg); }
    .btn.small { padding: 6px 8px; font-size: 12px; border-radius: 6px; }
    .vote { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 8px }
    .vote button { background: transparent; border: none; cursor: pointer; color: var(--muted); }
    .vote button:hover { color: var(--accent); }
    .votes-count { font-weight: 700; color: var(--text); }
    .profile { display: flex; gap: 10px; align-items: center }
    .avatar { width: 36px; height: 36px; border-radius: 10px; background: var(--border); display: flex; align-items: center; justify-content: center; color: var(--muted); font-weight: 700; }
    .notif-badge { background: #ef4444; color: white; border-radius: 10px; padding: 4px 6px; font-size: 12px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.45); display: flex; align-items: center; justify-content: center; padding: 16px; z-index: 999; }
    html.dark-mode .modal-backdrop { background: rgba(0, 0, 0, 0.8); }
    .thread-media img, .thread-media video { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; display: block; max-height: 400px; background: var(--border); border: 1px solid var(--border); }
    @media (max-width: 800px) {
      .grid { grid-template-columns: 1fr; }
      .brand h1 { font-size: 16px }
      .logo { width: 40px; height: 40px }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">OA</div>
        <div><h1>Obrolin ajaa</h1><p class="lead">Ruang Diskusi Tanpa Batas</p></div>
      </div>
      <div class="controls">
        <button class="icon-btn" id="theme-toggle" title="Ganti Tema"><span id="theme-icon">â˜€</span></button>
        <div class="profile" id="top-profile"></div>
        <button class="icon-btn" id="notif-btn" title="Notifikasi">ðŸ”” <span id="notif-count" style="margin-left: 6px"></span></button>
        <button class="btn" id="new-thread-btn">Buat Thread</button>
      </div>
    </header>

    <div class="grid">
      <aside class="card">
        <h3 style="margin-top: 0">Kategori</h3>
        <div class="categories" id="categories"></div>
        <hr style="margin: 12px 0; border-color: var(--border);">
        <div><strong>Info</strong><p style="color: var(--muted); font-size: 13px">Koneksi backend menggunakan Supabase. Semua data tersimpan di database.</p></div>
      </aside>
      <main>
        <div class="card" id="composer-card">
          <div style="display: flex; gap: 10px; align-items: flex-start">
            <div class="avatar" id="composer-avatar">G</div>
            <div style="flex: 1">
              <input type="text" id="thread-title" placeholder="Judul thread..." />
              <div style="height: 8px"></div>
              <textarea id="thread-body" placeholder="Tulis sesuatu untuk memulai diskusi..."></textarea>
              <div style="height: 8px"></div>
              <input type="text" id="thread-media-url" placeholder="URL Foto/Video/GIF (Opsional)" />
              <div style="display: flex; gap: 8px; justify-content: space-between; margin-top: 8px; align-items: center">
                <select id="thread-category"></select>
                <div style="display: flex; gap: 8px">
                  <button class="btn" id="post-thread">Posting</button>
                  <button class="btn secondary" id="clear-thread">Bersihkan</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div style="height: 14px"></div>
        <div id="threads-list"></div>
      </main>
    </div>
    <div id="modal-root"></div>
  </div>

<script>
    // ===============================================
    // ======= APLIKASI FORUM DENGAN SUPABASE ========
    // ===============================================

    // --- KONFIGURASI SUPABASE ---
    // Ganti dengan URL dan Kunci Anon dari proyek Supabase Anda
    const SUPABASE_URL = 'https://YOR_PROJECT_ID.supabase.co';
    const SUPABASE_ANON_KEY = 'YOR_ANON_KEY';
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Variabel Global
    let currentUser = null;
    const DEFAULT_CATS = ['Teknologi', 'Lifestyle', 'Edukasi', 'Hiburan', 'Umum'];
    const modalRoot = document.getElementById('modal-root');

    // ===== UI helpers =====
    function el(html) { const div = document.createElement('div'); div.innerHTML = html.trim(); return div.firstChild; }

    // ===== Theme Toggler Logic (Tidak Berubah) =====
    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    let isDarkMode = document.documentElement.classList.contains('dark-mode');
    
    function applyTheme() {
        if (isDarkMode) {
            document.documentElement.classList.add('dark-mode');
            themeIcon.textContent = 'ðŸŒ™';
            localStorage.setItem('obrolin_theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark-mode');
            themeIcon.textContent = 'â˜€';
            localStorage.setItem('obrolin_theme', 'light');
        }
    }
    themeIcon.textContent = isDarkMode ? 'ðŸŒ™' : 'â˜€';
    themeToggleBtn.onclick = () => { isDarkMode = !isDarkMode; applyTheme(); };

    // ===== Auth (DIGANTI DENGAN SUPABASE AUTH) =====
    async function renderTopProfile() {
        const root = document.getElementById('top-profile'); 
        root.innerHTML = '';
        if (currentUser) {
            const prof = el(`<div style="display:flex;gap:8px;align-items:center"><div class="avatar">${currentUser.user_metadata.name[0].toUpperCase()}</div><div style="text-align:right"><div style="font-size:13px">${currentUser.user_metadata.name}</div><div style="font-size:12px;color:var(--muted)">${currentUser.email}</div></div><button class="btn secondary" id="logout">Keluar</button></div>`);
            root.appendChild(prof);
            prof.querySelector('#logout').onclick = async () => {
                await supabase.auth.signOut();
            }
        } else {
            const login = el(`<div style="display:flex;gap:6px;align-items:center"><button class="btn" id="open-login">Masuk / Daftar</button></div>`);
            root.appendChild(login);
            login.querySelector('#open-login').onclick = openAuthModal;
        }
    }

    function openAuthModal() {
        showModal(`<div class="card" style="max-width:420px; padding:20px;"><h3>Masuk atau Daftar</h3>
            <p id="auth-error" style="color: #ef4444; font-size: 13px; display: none;"></p>
            <div style="display:grid;gap:10px;margin-top:12px">
                <input type="text" id="auth-name" placeholder="Nama (hanya untuk daftar)" />
                <input type="email" id="auth-email" placeholder="Email" />
                <input type="password" id="auth-pass" placeholder="Kata sandi (min. 6 karakter)" />
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                    <button class="btn secondary" id="close-auth">Tutup</button>
                    <button class="btn secondary" id="do-signup">Daftar</button>
                    <button class="btn" id="do-login">Masuk</button>
                </div>
            </div>
        </div>`);

        const errorEl = document.getElementById('auth-error');
        document.getElementById('close-auth').onclick = closeModal;

        document.getElementById('do-signup').onclick = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const email = document.getElementById('auth-email').value.trim();
            const pass = document.getElementById('auth-pass').value;
            if (!name) { errorEl.textContent = 'Nama wajib diisi untuk mendaftar.'; errorEl.style.display = 'block'; return; }

            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: pass,
                options: {
                    data: { name: name } // Simpan nama di metadata
                }
            });
            if (error) { errorEl.textContent = error.message; errorEl.style.display = 'block'; }
            else { closeModal(); alert('Pendaftaran berhasil! Silakan periksa email Anda untuk verifikasi (jika diaktifkan).'); }
        }

        document.getElementById('do-login').onclick = async () => {
            const email = document.getElementById('auth-email').value.trim();
            const pass = document.getElementById('auth-pass').value;
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: pass,
            });
            if (error) { errorEl.textContent = error.message; errorEl.style.display = 'block'; }
            else { closeModal(); }
        }
    }

    // ===== Modal helpers =====
    function showModal(inner) { modalRoot.innerHTML = `<div class="modal-backdrop">${inner}</div>`; }
    function closeModal() { modalRoot.innerHTML = ''; }

    // ===== Categories (Logika Tidak Berubah) =====
    function renderCategories(active = 'Semua') {
        const root = document.getElementById('categories'); root.innerHTML = '';
        ['Semua', ...DEFAULT_CATS].forEach(c => {
            const d = el(`<div class="cat ${c === active ? 'active' : ''}" data-cat="${c}">${c}</div>`);
            d.onclick = () => { renderCategories(c); renderThreads(c); document.getElementById('thread-category').value = (DEFAULT_CATS.includes(c) ? c : DEFAULT_CATS[0]); }
            root.appendChild(d);
        })
    }

    // ===== Composer (Logika Tidak Berubah) =====
    function renderComposer() {
        document.getElementById('composer-avatar').textContent = currentUser ? currentUser.user_metadata.name[0].toUpperCase() : 'G';
        const sel = document.getElementById('thread-category'); sel.innerHTML = ''; 
        DEFAULT_CATS.forEach(c => { 
            const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt); 
        });
        document.getElementById('post-thread').onclick = postThread;
        document.getElementById('clear-thread').onclick = () => { document.getElementById('thread-title').value = ''; document.getElementById('thread-body').value = ''; document.getElementById('thread-media-url').value = ''; }
    }

    // ===== Post Thread (DIGANTI DENGAN SUPABASE) =====
    async function postThread() {
        if (!currentUser) { openAuthModal(); return; }
        const title = document.getElementById('thread-title').value.trim();
        const body = document.getElementById('thread-body').value.trim();
        const category = document.getElementById('thread-category').value;
        const mediaUrl = document.getElementById('thread-media-url').value.trim();
        if (!title || !body) { alert('Judul dan isi thread wajib diisi.'); return; }

        const { error } = await supabase.from('threads').insert({
            title: title,
            body: body,
            category: category,
            media_url: mediaUrl,
            author_id: currentUser.id,
            author_name: currentUser.user_metadata.name
        });
        
        if (error) {
            alert('Gagal memposting thread: ' + error.message);
        } else {
            renderThreads();
            document.getElementById('thread-title').value = '';
            document.getElementById('thread-body').value = '';
            document.getElementById('thread-media-url').value = '';
        }
    }
    
    // ===== Render Threads (DIGANTI DENGAN SUPABASE) =====
    async function renderThreads(filter = 'Semua') {
        const list = document.getElementById('threads-list');
        list.innerHTML = '<div class="card" style="text-align:center; padding: 20px;">Memuat threads...</div>';

        let query = supabase.from('threads').select(`*, replies(count)`).order('created_at', { ascending: false });
        if (filter !== 'Semua') {
            query = query.eq('category', filter);
        }

        const { data: threads, error } = await query;

        if (error) {
            list.innerHTML = '<div class="card" style="text-align:center; padding: 20px; color: #ef4444;">Gagal memuat threads.</div>';
            console.error(error);
            return;
        }

        if (threads.length === 0) {
            list.innerHTML = '<div class="card" style="text-align:center; padding: 20px;">Belum ada thread. Jadilah yang pertama!</div>';
            return;
        }
        
        list.innerHTML = ''; // Hapus pesan "memuat"
        threads.forEach(t => {
            const mediaPreview = createMediaElement(t.media_url);
            const item = el(`
                <div class="card thread" style="padding:15px">
                    <div style="display:flex;gap:12px;align-items:flex-start">
                        <div class="vote">
                            <button class="up" data-id="${t.id}">â–²</button>
                            <div class="votes-count">${t.votes}</div>
                            <button class="down" data-id="${t.id}">â–¼</button>
                        </div>
                        <div style="flex:1">
                            <div style="display:flex;justify-content:space-between;align-items:start">
                                <div>
                                    <div style="font-weight:700">${escapeHtml(t.title)}</div>
                                    <div class="meta">oleh ${escapeHtml(t.author_name)} â€¢ ${new Date(t.created_at).toLocaleString()}</div>
                                </div>
                                <div class="meta">${escapeHtml(t.category)}</div>
                            </div>
                            <div style="margin-top:8px;color:var(--muted);">${escapeHtml(truncate(t.body, 200))}</div>
                            ${mediaPreview}
                            <div style="margin-top:10px;display:flex;gap:8px">
                                <button class="btn small" data-id="${t.id}" data-action="open">Buka (${t.replies[0].count} Balasan)</button>
                                <button class="btn secondary small" data-id="${t.id}" data-action="share">Bagikan</button>
                            </div>
                        </div>
                    </div>
                </div>`);
            list.appendChild(item);
            
            item.querySelector('[data-action=open]').onclick = () => openThread(t.id);
            item.querySelector('[data-action=share]').onclick = () => { navigator.clipboard?.writeText(window.location.href + '#t=' + t.id).then(() => alert('Link disalin ke clipboard')) }
            
            item.querySelector('.up').onclick = async () => {
                const { data, error } = await supabase.rpc('upvote_item', { item_id: t.id, item_type: 'thread' });
                if (!error) renderThreads(filter); // Re-render untuk update
            };
            item.querySelector('.down').onclick = async () => {
                 const { data, error } = await supabase.rpc('downvote_item', { item_id: t.id, item_type: 'thread' });
                if (!error) renderThreads(filter); // Re-render untuk update
            };
        });
    }
    
    // ===== Open Thread (DIGANTI DENGAN SUPABASE) =====
    async function openThread(id) {
        const { data: t, error } = await supabase.from('threads').select('*').eq('id', id).single();
        if (error || !t) { alert('Gagal membuka thread.'); return; }
        
        const mediaElementFull = createMediaElement(t.media_url);
        const { data: repliesData } = await supabase.from('replies').select('*').eq('thread_id', t.id).order('created_at');
        const repliesCount = repliesData ? repliesData.length : 0;

        let html = `<div class="card" style="max-width:820px; padding:20px; overflow-y: auto; max-height: 90vh;">
            <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="vote" style="padding:0;"><div style="font-size:24px; color:var(--accent);">${t.votes}</div><div class="meta">Votes</div></div>
                <div style="flex:1">
                    <h2 class="thread-title">${escapeHtml(t.title)}</h2>
                    <div class="meta">oleh ${escapeHtml(t.author_name)} â€¢ ${new Date(t.created_at).toLocaleString()} â€¢ ${escapeHtml(t.category)}</div>
                    <div style="height:12px"></div>
                    <div style="white-space:pre-wrap; margin-bottom:15px;">${escapeHtml(t.body)}</div>
                    ${mediaElementFull}
                    <div class="thread-actions"><button class="btn secondary" id="close-thread">Tutup</button></div>
                </div>
            </div>
            <hr style="margin:16px 0; border-color: var(--border);">
            <h3 style="margin-top:0">Balasan (${repliesCount})</h3>
            <div id="replies-root"></div>
            <div style="height:10px"></div>
            <div class="card" style="padding:10px 14px; border:1px solid var(--border); box-shadow:none;">
                <div style="display:flex;gap:10px">
                    <div class="avatar">${currentUser ? currentUser.user_metadata.name[0].toUpperCase() : 'G'}</div>
                    <div style="flex:1">
                        <textarea id="reply-body" placeholder="${currentUser ? 'Tulis balasan...' : 'Silakan masuk untuk membalas...'}" ${currentUser ? '' : 'disabled'}></textarea>
                        <div style="display:flex;justify-content:flex-end;margin-top:8px">
                            <button class="btn" id="post-reply" ${currentUser ? '' : 'disabled'}>Kirim Balasan</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        showModal(html);

        renderReplies(t.id);
        document.getElementById('close-thread').onclick = closeModal;
        document.getElementById('post-reply').onclick = async () => {
            if (!currentUser) { closeModal(); openAuthModal(); return; }
            const body = document.getElementById('reply-body').value.trim(); 
            if (!body) { alert('Tulis pesan terlebih dahulu'); return; }
            
            const { error } = await supabase.from('replies').insert({
                body: body,
                author_id: currentUser.id,
                author_name: currentUser.user_metadata.name,
                thread_id: t.id
            });
            if (!error) {
                document.getElementById('reply-body').value = '';
                renderReplies(t.id);
                // NOTIFIKASI: Kirim notifikasi jika yang balas bukan pemilik thread
                if (t.author_id !== currentUser.id) {
                    await supabase.from('notifications').insert({
                        user_id: t.author_id, // Kirim ke pemilik thread
                        thread_id: t.id,
                        thread_title: t.title,
                        from_user_name: currentUser.user_metadata.name
                    });
                }
            } else {
                alert('Gagal mengirim balasan: ' + error.message);
            }
        }
    }

    async function renderReplies(threadId) {
        const root = document.getElementById('replies-root'); 
        root.innerHTML = 'Memuat balasan...';
        const { data: replies, error } = await supabase.from('replies').select('*').eq('thread_id', threadId).order('created_at');
        
        if (error) { root.innerHTML = 'Gagal memuat balasan.'; return; }

        root.innerHTML = '';
        replies.forEach(r => {
            const rep = el(`<div class="reply">
                <div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(r.author_name)}</strong><div class="meta">${new Date(r.created_at).toLocaleString()}</div></div><div class="meta">Votes: <span class="votes-count-reply">${r.votes}</span></div></div><div style="margin-top:8px;white-space:pre-wrap">${escapeHtml(r.body)}</div>
                <div style="margin-top:8px;display:flex;gap:8px">
                    <button class="icon-btn" data-id="${r.id}" data-action="up">â–²</button>
                    <button class="icon-btn" data-id="${r.id}" data-action="down">â–¼</button>
                </div>
            </div>`);
            root.appendChild(rep);

            rep.querySelector('[data-action=up]').onclick = async () => {
                await supabase.rpc('upvote_item', { item_id: r.id, item_type: 'reply' });
                renderReplies(threadId);
            }
            rep.querySelector('[data-action=down]').onclick = async () => {
                await supabase.rpc('downvote_item', { item_id: r.id, item_type: 'reply' });
                renderReplies(threadId);
            }
        });
    }

    // ===== Utilities (Tidak Berubah) =====
    function createMediaElement(url) {
        if (!url) return '';
        const ext = url.split('.').pop().toLowerCase().split('?')[0];
        let mediaHtml = '';
        if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) { mediaHtml = `<img src="${url}" alt="Thread Media" loading="lazy">`; } 
        else if (['mp4', 'webm', 'ogg'].includes(ext)) { mediaHtml = `<video src="${url}" controls loading="lazy"></video>`; }
        return mediaHtml ? `<div class="thread-media">${mediaHtml}</div>` : '';
    }
    function escapeHtml(s) { if (!s) return ''; return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;'); }
    function truncate(s, n) { return s.length > n ? s.slice(0, n - 1) + 'â€¦' : s; }

    // ===== Notifications =====
    async function updateNotifUI() {
        const span = document.getElementById('notif-count');
        if (!currentUser) { 
            span.innerHTML = ''; 
            document.getElementById('notif-btn').onclick = () => { openAuthModal(); }; 
            return; 
        }

        const { count } = await supabase.from('notifications').select('*', { count: 'exact', head: true }).eq('user_id', currentUser.id).eq('read', false);
        
        span.innerHTML = count > 0 ? `<span class="notif-badge">${count}</span>` : '';
        document.getElementById('notif-btn').onclick = () => { openNotifPanel(); }
    }

    async function openNotifPanel() {
        if (!currentUser) return openAuthModal();

        const { data: nots, error } = await supabase.from('notifications').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
        if(error){ alert('Gagal memuat notifikasi'); return; }

        let html = `<div class="card" style="max-width:420px; padding:20px;"><h3>Notifikasi</h3><div style="display:flex;flex-direction:column;gap:8px; margin-top:12px; max-height: 400px; overflow-y: auto;">`;
        nots.forEach(n => { html += `<div style="padding:8px;border-radius:8px;background:${n.read ? 'var(--card)' : 'rgba(37,99,235,0.08)'}; border:1px solid var(--border);"><div style="font-weight:700">${escapeHtml(n.from_user_name)}</div><div style="color:var(--muted);font-size:13px">Membalas thread: <a href="#t=${n.thread_id}" onclick="closeModal(); setTimeout(()=>openThread('${n.thread_id}'), 100);" style="color:var(--accent); text-decoration:none;">${escapeHtml(n.thread_title)}</a></div><div style="font-size:12px;color:var(--muted)">${new Date(n.created_at).toLocaleString()}</div></div>` });
        html += `</div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:15px"><button class="btn secondary" id="close-notif">Tutup</button><button class="btn" id="mark-read">Tandai sudah dibaca</button></div></div>`;
        showModal(html);
        
        document.getElementById('close-notif').onclick = closeModal;
        document.getElementById('mark-read').onclick = async () => { 
            await supabase.from('notifications').update({ read: true }).eq('user_id', currentUser.id);
            closeModal(); 
            updateNotifUI(); 
        }
    }


    // ===== Bootstrap & Event Listener Utama =====
    document.addEventListener('DOMContentLoaded', () => {
        supabase.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user ?? null;
            renderTopProfile();
            renderComposer();
            updateNotifUI();
            // Muat ulang threads jika ada perubahan login/logout agar voting/aksi lain terlihat
            const currentCategory = document.querySelector('.cat.active')?.dataset.cat || 'Semua';
            renderThreads(currentCategory);
        });

        document.getElementById('new-thread-btn').onclick = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); document.getElementById('thread-title').focus(); }
        
        renderCategories(); // Render kategori sekali saat halaman dimuat
    });

</script>
</body>
</html>
